<?xml version="1.0" encoding="utf-8"?>

<!--
  BigBlueButton open source conferencing system - http://www.bigbluebutton.org
  
  Copyright (c) 2010 BigBlueButton Inc. and by respective authors (see below).
  
  BigBlueButton is free software; you can redistribute it and/or modify it under the 
  terms of the GNU Lesser General Public License as published by the Free Software 
  Foundation; either version 2.1 of the License, or (at your option) any later 
  version. 
  
  BigBlueButton is distributed in the hope that it will be useful, but WITHOUT ANY 
  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A 
  PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
  
  You should have received a copy of the GNU Lesser General Public License along 
  with BigBlueButton; if not, see <http://www.gnu.org/licenses/>.
 
  $Id: $
-->

<!--
Notes.mxml is the main view of the SharedNotes application
-->
<MDIWindow xmlns="flexlib.mdi.containers.*"
        xmlns:mx="http://www.adobe.com/2006/mxml"
	width="450" height="550" 
	xmlns:mate="http://mate.asfusion.com/" 
	implements="org.bigbluebutton.common.IBbbModuleWindow" 
	creationComplete="onCreationComplete()"
	label="Create New Poll" layout="absolute" 
	title="Create New Poll">
	
	<!-- Pre Defined Validation -->
	
	
	
	
	<mx:Script>
		<![CDATA[
			import flexlib.mdi.events.MDIWindowEvent;
			
			import org.bigbluebutton.main.views.MainCanvas;
			import mx.controls.Alert;
			import org.bigbluebutton.common.LogUtil;
			import mx.validators.Validator;	
			
			//EVENTS
			import org.bigbluebutton.modules.polling.events.PollingInstructionsWindowEvent; 
			import org.bigbluebutton.modules.polling.events.StartPollingEvent;
			import org.bigbluebutton.modules.polling.events.AcceptPollingInstructionsWindowEvent;

		
			public static const LOGNAME:String = "[PollingInstructionsWindow] ";	

			public var moduleAttributes:Object;
			private var userName:String;
			
			public function getPrefferedPosition():String{
				return MainCanvas.POPUP;
			}
 
			private function onCreationComplete():void{
				LogUtil.debug(LOGNAME + "Inside Creation Complete");
				LogUtil.debug(LOGNAME + "Instructions Window is Created");
				userName = moduleAttributes.username;
			}
			
			public function sendNewMessage():void{
				//proxy.sendMessage(userName + "::: " + txtInput.text);
			}
			
			public function displayNewMessage(message:String):void{
				//txtArea.text += "\n" + message;
			}
			
			/*
			 * Override the close handler. We want the Event Map to send a message to
			 * the MDIManager to close this window;
			 */
			override public function close(event:MouseEvent = null):void {
				closeInstructionsWindow();
			}		
			
			private function closeInstructionsWindow():void {	
				LogUtil.debug(LOGNAME + "inside  closeinstructionsWindow");		

				dispatchEvent(new PollingInstructionsWindowEvent(PollingInstructionsWindowEvent.CLOSE));				
			}		
			
			private function openAcceptInstructions():void {
				LogUtil.debug(LOGNAME + "inside  acceptInstructions");		
				dispatchEvent(new AcceptPollingInstructionsWindowEvent(AcceptPollingInstructionsWindowEvent.OPEN));
				closeInstructionsWindow()
			titleErrMsg.text="";
			}
			

			private function StartPolling():void {
				LogUtil.debug(LOGNAME + "inside  StartPolling calling StartPollingEvent ");		
				dispatchEvent(new StartPollingEvent(StartPollingEvent.START));
				closeInstructionsWindow();
			}
			
			// DATA VALIDATION
			//##################################################################################
			private function validateAndSubmit():void {
			  var valid:Boolean = true;
			  
			  // Gathering Error Messages
				titleErrMsg.text = titleError();
				qErrMsg.text = questionError();
				aErrMsg.text = answerError();
				
			// Making Error messages Visible if there is an Error
			
			    if (titleErrMsg.text != "VALID"){ // checking if function returned any error string
			     	titleErrMsg.visible=true;
			     	valid = false;	// setting flag to false in case of error
			    }else 
			       titleErrMsg.visible=false;
			   
			   
			    if(qErrMsg.text != "VALID"){
			    	qErrMsg.visible=true;
			    	valid = false;	
			    } else 
			        qErrMsg.visible=false;
			    
			    
			    if (aErrMsg.text != "VALID") {
			    	aErrMsg.visible=true;
			    	valid = false;	
			    }else 
			        aErrMsg.visible=false;
			   
			    if(valid)
			    	StartPolling();
			    
			
			
			}
			
			// GENERATING ERROR MESSAGES
			//################################
			private function   titleError():String{
			
			   var errMsg:String = "VALID";
			   var titlePattern:RegExp =  /^[a-zA-Z0-9_., ?\']*$/; // alpha comma, dot, space and some others are allowed in title
		     
			     if (pollTitle.length == 0 )
			     		errMsg = "Please Provide a Title";
			       else if(!titlePattern.test(pollTitle.text))
			   		errMsg = "Title has forbidden characters";			
			  return errMsg;
			}
			
			private function   questionError():String{
			
			   var errMsg:String = "VALID";
			   var qPattern:RegExp =  /^[a-zA-Z0-9_., ?!\']*$/; // alpha comma, dot, space and some others are allowed in question
		     
			     if (pollQuestion.length == 0 )
			     		errMsg = "Please Provide a Question";
			       else if(!qPattern.test(pollQuestion.text))
			   		errMsg = "Question field has forbidden characters";			
			  return errMsg;
			}
			
			private function   answerError():String{
			
			   var errMsg:String = "VALID";
			   var aPattern:RegExp =  /^[a-zA-Z0-9_., ?!\'/]*$/; // alpha comma, dot, space and some others are allowed in alpha
		     
			     if (pollAnswers.length == 0 )
			     		errMsg = "Please Provide at least 2 Answers";
			       else if(!aPattern.test(pollAnswers.text))
			   		errMsg = "Answer field has forbidden characters";			
			  return errMsg;
			}
		//#####################################################################################################	
		]]>
	</mx:Script>
	<!-- Prorotype of Polling Instructions Design -->

	
       
           <mx:VBox width="90%" height="90%"  >
            <mx:Form width="90%"  id="instructionsForm" paddingLeft="10" paddingRight="10" paddingTop="30" paddingBottom="10">
           
            
	      <mx:FormItem fontWeight="bold"   label="Title :" paddingLeft="35" required="true" >
		<mx:TextInput id="pollTitle" /> 
		<mx:Label id="titleErrMsg"  text="" visible="false" width="100%" color="red" fontSize="9"/> 
	      </mx:FormItem>
		
	      <mx:FormItem  fontWeight="bold" label="Question :" paddingLeft="35"  paddingTop="20"  >
		<mx:TextArea id="pollQuestion" width="200" height="100" /> 
		<mx:Label id="qErrMsg"  text="" visible="false" width="100%" color="red" fontSize="9"/> 
	     </mx:FormItem>
	     
	      <mx:FormItem  fontWeight="bold" label="Answers :" paddingLeft="35"  paddingTop="30"  >
		<mx:TextArea id="pollAnswers" width="200" height="100" /> 
		<mx:Label id="aErrMsg"  text="" visible="false" width="100%" color="red" fontSize="9"/> 
	     </mx:FormItem>
	     
	      <mx:FormItem  paddingLeft="10"  paddingTop="20" >
	         <mx:CheckBox id="multiple_response" label="Allow users to choose more than one response" click="" />
	      </mx:FormItem>
	   
	 
	    </mx:Form> 
	   </mx:VBox>
	   
	   <!-- BUTTONS -->
	   <mx:ControlBar width="100%" >
		<mx:HBox paddingLeft="70" paddingRight="10" paddingTop="10" paddingBottom="10">  
       			<mx:Button id="CreatePoll" label="Create Poll" click="validateAndSubmit()"  width="100" height="30"/>
			<mx:Button id="Cancell" label="Cancel" click="closeInstructionsWindow()"  width="100" height="30"/>
		</mx:HBox>	 
	   </mx:ControlBar> 	 
	   <!-- END OF BUTTONS -->
	     

</MDIWindow>
